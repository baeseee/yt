<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸµ ë‚´ê°€ ì¢‹ì•„í•˜ëŠ” ë…¸ë˜</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
    }
    h1 {
      margin-bottom: 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #eee;
      cursor: pointer;
    }
    .form-group {
      margin-bottom: 10px;
    }
    input, select {
      padding: 5px;
      margin-right: 10px;
    }
    button {
      padding: 5px 10px;
      margin-right: 5px;
    }
    .delete-btn, .edit-btn {
      cursor: pointer;
      margin: 0 3px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      position: relative;
      background: white;
      width: 90%;
      max-width: 800px;
      aspect-ratio: 16/9;
    }
    .modal iframe {
      width: 100%;
      height: 100%;
    }
    .modal-close {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>ğŸ¶ ë‚´ê°€ ì¢‹ì•„í•˜ëŠ” ë…¸ë˜ ëª©ë¡</h1>

  <!-- ì…ë ¥ í¼ -->
  <div class="form-group">
    <select id="typeInput">
      <option value="êµ­ë‚´">êµ­ë‚´</option>
      <option value="í•´ì™¸">í•´ì™¸</option>
      <option value="ê²Œì„">ê²Œì„</option>
      <option value="ì• ë‹ˆ">ì• ë‹ˆ</option>
    </select>
    <input type="text" id="titleInput" placeholder="ë…¸ë˜ ì œëª©" />
    <input type="text" id="artistInput" placeholder="ê°€ìˆ˜" />
    <input type="number" id="yearInput" placeholder="ë°œí‘œë…„ë„" />
    <input type="text" id="linkInput" placeholder="ìœ íŠœë¸Œ ë§í¬" />
    <button onclick="addSong()">ì¶”ê°€</button>
  </div>

  <!-- í•„í„° -->
  <div class="form-group">
    <label>êµ¬ë¶„:
      <select id="typeFilter" onchange="renderTable()">
        <option value="all">ì „ì²´</option>
        <option value="êµ­ë‚´">êµ­ë‚´</option>
        <option value="í•´ì™¸">í•´ì™¸</option>
        <option value="ê²Œì„">ê²Œì„</option>
        <option value="ì• ë‹ˆ">ì• ë‹ˆ</option>
      </select>
    </label>
    <label>ê²€ìƒ‰:
      <input type="text" id="searchInput" placeholder="ì œëª© ë˜ëŠ” ê°€ìˆ˜" oninput="renderTable()" />
    </label>
  </div>

  <!-- í…Œì´ë¸” -->
  <table id="songTable">
    <thead>
      <tr>
        <th>êµ¬ë¶„</th>
        <th>ì œëª©</th>
        <th>ê°€ìˆ˜</th>
        <th onclick="toggleSort()">ë°œí‘œë…„ë„ â¬</th>
        <th>ë“£ê¸°</th>
        <th>ì‘ì—…</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ë°±ì—…/ë³µì› -->
  <div style="margin-top: 20px;">
    <button onclick="backupDataToFile()">ğŸ“ ë°±ì—… ì €ì¥í•˜ê¸°</button>
    <input type="file" id="restoreInput" accept=".json" onchange="restoreDataFromFile(event)" />
  </div>

  <!-- ëª¨ë‹¬ -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="youtubeFrame"></div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let playlist = [];
    let currentIndex = null;
    let currentSortField = null;
    let sortAsc = true;
    let ytPlayer = null;

    const STORAGE_KEY = "playlist";

    function loadData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) playlist = JSON.parse(saved);
      renderTable();
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(playlist));
    }

    function addSong() {
      const type = document.getElementById("typeInput").value;
      const title = document.getElementById("titleInput").value.trim();
      const artist = document.getElementById("artistInput").value.trim();
      const year = parseInt(document.getElementById("yearInput").value);
      const link = document.getElementById("linkInput").value.trim();

      if (!title || !artist || isNaN(year) || !link) {
        alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      playlist.push({ type, title, artist, year, link });
      saveData();
      renderTable();

      document.getElementById("titleInput").value = "";
      document.getElementById("artistInput").value = "";
      document.getElementById("yearInput").value = "";
      document.getElementById("linkInput").value = "";
    }

    function deleteSong(index) {
      if (confirm("ì´ ë…¸ë˜ë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
        playlist.splice(index, 1);
        saveData();
        renderTable();
      }
    }

    function editSong(index) {
      const item = playlist[index];
      const title = prompt("ì œëª©", item.title);
      const artist = prompt("ê°€ìˆ˜", item.artist);
      const year = prompt("ë°œí‘œë…„ë„", item.year);
      const link = prompt("ë§í¬", item.link);

      if (title && artist && !isNaN(parseInt(year)) && link) {
        playlist[index] = {
          ...item,
          title: title.trim(),
          artist: artist.trim(),
          year: parseInt(year),
          link: link.trim(),
        };
        saveData();
        renderTable();
      } else {
        alert("ì…ë ¥ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    }

    function renderTable() {
      const tbody = document.querySelector("#songTable tbody");
      tbody.innerHTML = "";

      const filter = document.getElementById("typeFilter").value;
      const search = document.getElementById("searchInput").value.toLowerCase();

      let filtered = playlist.filter(
        (item) =>
          (filter === "all" || item.type === filter) &&
          (item.title.toLowerCase().includes(search) || item.artist.toLowerCase().includes(search))
      );

      if (currentSortField === 'year') {
        filtered.sort((a, b) => sortAsc ? a.year - b.year : b.year - a.year);
      }

      filtered.forEach((item, idx) => {
        const realIndex = playlist.indexOf(item);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.type}</td>
          <td>${item.title}</td>
          <td>${item.artist}</td>
          <td>${item.year}</td>
          <td><a href="#" onclick="openModal('${item.link}', ${realIndex})">â–¶ï¸ ë“£ê¸°</a></td>
          <td>
            <span class="edit-btn" onclick="editSong(${realIndex})">âœï¸</span>
            <span class="delete-btn" onclick="deleteSong(${realIndex})">ğŸ—‘ï¸</span>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function backupDataToFile() {
      const blob = new Blob([JSON.stringify(playlist, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "my_playlist_backup.json";
      a.click();
    }

    function restoreDataFromFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (Array.isArray(imported)) {
            playlist = imported;
            saveData();
            renderTable();
            alert("ë³µì› ì™„ë£Œ!");
          } else {
            alert("ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.");
          }
        } catch {
          alert("ë³µì› ì‹¤íŒ¨");
        }
      };
      reader.readAsText(file);
    }

    function toggleSort() {
      if (currentSortField === 'year') {
        sortAsc = !sortAsc;
      } else {
        currentSortField = 'year';
        sortAsc = true;
      }
      renderTable();
    }

    function extractVideoId(url) {
      const match = url.match(/(?:youtu.be\/|v=)([\w-]{11})/);
      return match ? match[1] : null;
    }

    function openModal(link, index) {
      currentIndex = index;
      const videoId = extractVideoId(link);
      if (!videoId) return alert("ì˜ëª»ëœ ë§í¬ì…ë‹ˆë‹¤.");

      document.getElementById("modal").style.display = "flex";
      if (ytPlayer) {
        ytPlayer.loadVideoById(videoId);
      } else {
        ytPlayer = new YT.Player("youtubeFrame", {
          videoId,
		  playerVars: {
			autoplay: 1  // âœ… ì¶”ê°€ëœ ë¶€ë¶„
		  },
          events: {
            'onStateChange': onPlayerStateChange
          }
        });
      }
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
      if (ytPlayer) ytPlayer.stopVideo();
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        playNext();
      }
    }

    function playNext() {
      const filter = document.getElementById("typeFilter").value;
      const search = document.getElementById("searchInput").value.toLowerCase();

      let filtered = playlist.filter(
        (item) =>
          (filter === "all" || item.type === filter) &&
          (item.title.toLowerCase().includes(search) || item.artist.toLowerCase().includes(search))
      );

      if (currentSortField === 'year') {
        filtered.sort((a, b) => sortAsc ? a.year - b.year : b.year - a.year);
      }

      const currentSong = playlist[currentIndex];
      const currentFilteredIndex = filtered.findIndex(item => item === currentSong);

      if (currentFilteredIndex + 1 < filtered.length) {
        const nextSong = filtered[currentFilteredIndex + 1];
        const nextIndex = playlist.indexOf(nextSong);
        openModal(nextSong.link, nextIndex);
      } else {
        closeModal();
      }
    }

    window.onload = loadData;
  </script>
</body>
</html>
